# Bash

*Авторы: Георгий Ангени, Даниил Любаев, Денис Коротченко*

[Miro-доска со структурной диаграммой классов](https://miro.com/app/board/uXjVMoXRn9w=/?share_link_id=54401486908)

### Описание работы

Верхнеуровневый REPL в цикле считывает строки, которые передаются на вход `Bash.execute`, который передаёт их `PipelineParser.parsePipeline`.

`PipelineParser` содержит внутри себя `PipelineSplitter`, после получения на вход строки передаёт её на вход `PipelineSplitter.splitPipeline`, которая разделяет при помощи `|`, пропуская при этом символы `|` внутри кавычек.

Каждая из строк при помощи `PipeParser` (который хранится внутри `PipelineParser`) превращает каждую из строк в `Pipe`.

Для этого строка передаётся функции `splitToCommandAndArgs` в `CommandSplitter` (который хранится внутри `PipeParser`), которая разделяет строку по пробелам (учитывая кавычки), затем в строку при помощи метода `substitute` компонента `EnvVariableSubstitutor` подставляются значения переменных.

После этого `splitToCommandAndArgs` берёт первый выделенный элемент и преобразует его в команду (при помощи `CommandIndex`, который по факту является фабрикой команд и знает о том, какое название какой команде соответствует).
Остальные строки становятся аргументами команды.

Полученный результат собирается в `Pipe`, который хранит внутри себя команду и список аргументов.

Таким образом `PipelineParser` собирает список `Pipe`, который возвращает итоговый `Pipeline` в `Bash.execute`.

После этого `Bash` вызывает `Pipeline.runPipeline`, который в свою очередь поочередно запускает у каждого `Pipe` метод `runPipe`. Внутри себя этот метод дергает `Command.run`, получая выход команды. Этот выход внутри `runPipeline` передаётся на вход следующему `Pipe.run`.
В результате работы получается результат последнего Pipe.run, который в распакованном виде (то есть как пара из строки и кода возврата) возвращается в качестве ответа Bash.execute.

В момент исполнения команды Exit выбрасывается особое исключение, которое перехватывает REPL, который в свою очередь корректно завершает работы программы.

### Grep
Для разбора аргументов в `grep` была выбрана библиотека `urfave/cli`. Выбор был между ней и `spf13/cobra`.
Последняя является достаточно объемной, а т.к. нам нужна была очень небольшая часть, то выбор был в стороне более минималистичной библиотеки.

### Сборка
```go
go build .
```

### Запуск
```go
go run .
```
